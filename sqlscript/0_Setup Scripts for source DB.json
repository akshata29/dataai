{
	"name": "0_Setup Scripts for source DB",
	"properties": {
		"folder": {
			"name": "Lakehouse"
		},
		"content": {
			"query": "-- Run following setup script on source Database to create tables and enable CDC\n\n-- To create the source table, copy and paste the code snippet below and click Run\nCREATE TABLE Customers (\n    CustomerID int IDENTITY(1,1) PRIMARY KEY,\n    CustomerAddress varchar(255) NOT NULL\n);\n\n\n-- To enable change data capture on the source table, copy and paste the code snippet below and click Run\nEXEC sys.sp_cdc_enable_db;\nEXEC sys.sp_cdc_enable_table  \n    @source_schema = N'dbo',  \n    @source_name   = N'Customers',  \n    @role_name     = NULL,\n    @supports_net_changes = 1;\n\n\n-- To load the source table with data, copy and paste the code snippet below and click Run\nINSERT INTO dbo.Customers (CustomerAddress)\nVALUES\n    ('82 Margate Drive, Sheffield S4 8FQ'),\n    ('135 High Barns, Ely, CB7 4RH'),\n    ('39 Queen Annes Drive, Bedale, DL8 2EL');\n\n-- Once you ran the 0_IncrementalCustomerCdc Pipeline once, we can run following to test out the updates/inserts before building triggers\nUPDATE dbo.Customers SET CustomerAddress = 'Guyzance Cottage, Guyzance NE65 9AF' WHERE CustomerID = 3;\nINSERT INTO dbo.Customers (CustomerAddress)\nVALUES\n    ('322 Fernhill, Mountain Ash, CF45 3EN'),\n    ('381 Southborough Lane, Bromley, BR2 8BQ');\nSELECT * FROM [dbo].[Customers];\n\n-- Copy and paste the code snippet below and click Run. Note: There may be some latency between the changes being executed and the changes \n-- being recorded in the related CDC table. You may need to wait a minute or two between steps to get the correct start_time and end_time values.\nDECLARE @max_lsn binary(10);\nSET @max_lsn = sys.fn_cdc_get_max_lsn();  \nSELECT\nCONVERT(varchar(16), DATEADD(minute, -1, sys.fn_cdc_map_lsn_to_time(@max_lsn)), 20) as start_time,\nCONVERT(varchar(16), DATEADD(minute, 1, sys.fn_cdc_map_lsn_to_time(@max_lsn)), 20) as end_time\n\n-- Copy and paste the start_time and end_time values into a text editor (e.g. Notepad). \n-- This will be used as input for the pipeline rerun to isolate the second batch of changes made to the dbo.Customers table.\n\n-- Using the start_time and end_time values from the previous step, we will rerun our pipeline and confirm that the changes have been copied \n-- to the Azure Data Lake Gen2 Storage Account.\n\n-- When the pipeline run is complete, under the Output tab, click the Details icon of the Copy data activity to confirm \n-- that three rows have been written to the data lake.\n\n-- create the source table\n-- For Order Tables (using Watermark)\nCREATE TABLE Orders (\n    OrderID int IDENTITY(1,1) PRIMARY KEY,\n    CustomerID int FOREIGN KEY REFERENCES Customers(CustomerID),\n    Quantity int NOT NULL,\n    OrderDateTime DATETIME default CURRENT_TIMESTAMP,\n    LastModifiedDateTime DATETIME default CURRENT_TIMESTAMP\n);\nINSERT INTO dbo.Orders (CustomerID, Quantity)\nVALUES\n    (1,38),\n    (2,27),\n    (3,16),\n    (1,52);\n\n-- create a SQL trigger that will automatically update the LastModifiedDateTime colum on UPDATE\nCREATE TRIGGER trg_orders_update_modified\nON dbo.Orders\nAFTER UPDATE \nAS\n    UPDATE dbo.Orders\n    SET LastModifiedDateTime = CURRENT_TIMESTAMP\n    FROM Inserted i\n    WHERE dbo.Orders.OrderID = i.OrderID;\n\n-- initialize the watermark table\nCREATE TABLE Watermark (\n    TableName varchar(255),\n    Watermark DATETIME\n);\nINSERT INTO dbo.Watermark\nVALUES\n('dbo.Orders', '1/1/2022 12:00:00 AM');\n\n-- enable the ability to programmatically update the watermark value via a stored procedure\nCREATE PROCEDURE sp_update_watermark @LastModifiedDateTime datetime, @TableName varchar(50)\nAS\n    UPDATE Watermark\n    SET [Watermark] = @LastModifiedDateTime\n    WHERE [TableName] = @TableName;\n    ",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}